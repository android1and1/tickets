// Generated by CoffeeScript 2.2.2
(function() {
  var Article, ArticleModel, Comment, CommentModel, Nohm, NohmModel, adb, assert, cdb, nohm;

  assert = require('assert');

  nohm = require('nohm');

  Nohm = nohm.Nohm;

  NohmModel = nohm.NohmModel;

  // keep global db-like variables.
  CommentModel = void 0;

  ArticleModel = void 0;

  cdb = void 0;

  adb = void 0;

  Article = (function() {
    class Article extends NohmModel {};

    Article.modelName = 'article';

    Article.idGenerator = 'increment';

    Article.definitions = {
      title: {
        type: 'string',
        unique: true,
        validations: ['notEmpty']
      },
      intro: {
        type: 'string',
        validations: ['notEmpty']
      },
      content: {
        type: 'string'
      },
      visits: {
        type: 'integer',
        defaultValue: 0
      }
    };

    return Article;

  }).call(this);

  Comment = (function() {
    class Comment extends NohmModel {};

    Comment.modelName = 'comment';

    Comment.idGenerator = 'increment';

    Comment.definitions = {
      reader: {
        type: 'string',
        index: true,
        validations: ['notEmpty']
      },
      title: {
        type: 'string',
        unique: true,
        validations: ['notEmpty']
      },
      stars: {
        type: 'integer',
        validations: [
          'notEmpty',
          function(newv) {
            var result;
            result = false;
            if (typeof parseInt(newv) === 'number' && parseInt(newv) <= 5) {
              result = true;
            }
            return Promise.resolve(result);
          }
        ]
      },
      content: {
        type: 'string'
      }
    };

    return Comment;

  }).call(this);

  describe('Link Behaviour Of Nohm API:', function() {
    before(function() {
      var client;
      client = (require('redis')).createClient();
      client.on('error', function(err) {
        console.error(err.message);
        throw TypeError('No Redis Server Connection');
      });
      return client.on('connect', async function() {
        Nohm.setClient(this);
        Nohm.setPrefix('laofu');
        // register class
        CommentModel = Nohm.register(Comment);
        ArticleModel = Nohm.register(Article);
        
        //cdb == Comment DB,adb == Article DB
        cdb = (await Nohm.factory('comment'));
        adb = (await Nohm.factory('article'));
        
        // before new test,clear the db.
        return (await Nohm.purgeDb(this));
      });
    });
    it('create 1 comment and 1 article,should successfully::', async function() {
      var res;
      adb.property({
        title: 'a delicate truth',
        intro: 'len zhan',
        content: 'at word II ,in britian da shi guan.'
      });
      res = (await adb.validate(void 0, false));
      if (res) {
        await adb.save();
      } else {
        console.log(adb.errors);
      }
      cdb.property({
        title: 'comment about a delicate truth',
        reader: 'su ning',
        stars: 2,
        content: 'it is wonderfulexperien while reading this story.'
      });
      res = (await cdb.validate(void 0, false));
      if (res) {
        await cdb.save();
      } else {
        console.log(cdb.errors);
      }
      
      // till here,means 1 article and 1 comment is created.
      return assert.ok(res);
    });
    it('comment id 1 should has correctly inf::', async function() {
      var properties;
      properties = (await cdb.load(1));
      assert(properties.title === 'comment about a delicate truth');
      properties = (await adb.load(1));
      return assert(properties.title === 'a delicate truth');
    });
    return describe('adb id1 link 2 comments should success::', function() {
      before(async function() {
        adb = (await Nohm.factory('article', 1)); // this instance created at step1(test1).
        return cdb = (await Nohm.factory('comment', 1)); // this instance created at step1(test1).
      });
      it('article id1 current has no links::', async function() {
        var num;
        num = (await adb.numLinks('comment'));
        return assert.equal(num, 0);
      });
      return it('article id1 link comments id1 and id2 should success::', async function() {
        var cdb2, num;
        cdb2 = new CommentModel;
        cdb2.property({
          title: 'comment of new york',
          stars: 4,
          reader: 'tony',
          content: ' Great Stroy,i like it.'
        });
        // cdb2 will be saved after adb save().
        adb.link(cdb);
        adb.link(cdb2);
        await adb.save();
        num = (await adb.numLinks('comment'));
        return assert.equal(num, 2);
      });
    });
  });

}).call(this);
